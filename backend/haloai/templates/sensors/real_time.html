{% extends 'base.html' %} {% block title %}{{ page_title }}{% endblock %} {%
block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">{{ page_title }}</h2>
      <p class="text-muted">Monitor your farms and sensors in real-time</p>
    </div>
  </div>

  <!-- Control Panel -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Monitor Controls</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <label for="farmSelect" class="form-label">Select Farm:</label>
              <select
                class="form-select"
                id="farmSelect"
                onchange="changeFarm()"
              >
                <option value="">All Farms</option>
                {% for farm in farms %}
                <option value="{{ farm }}">{{ farm|title }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label for="sensorSelect" class="form-label"
                >Select Sensor:</label
              >
              <select
                class="form-select"
                id="sensorSelect"
                onchange="changeSensor()"
              >
                <option value="">All Sensors</option>
                {% for sensor in sensor_types %}
                <option value="{{ sensor }}">{{ sensor|title }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label for="refreshRate" class="form-label">Refresh Rate:</label>
              <select
                class="form-select"
                id="refreshRate"
                onchange="changeRefreshRate()"
              >
                <option value="5">5 seconds</option>
                <option value="10" selected>10 seconds</option>
                <option value="30">30 seconds</option>
                <option value="60">1 minute</option>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button
                class="btn btn-success me-2"
                id="toggleMonitor"
                onclick="toggleMonitoring()"
              >
                <i class="fas fa-play"></i> Start Monitor
              </button>
              <button class="btn btn-secondary" onclick="manualRefresh()">
                <i class="fas fa-sync"></i> Refresh
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Indicators -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Connection Status</h5>
          <span class="badge bg-success" id="connectionStatus">Connected</span>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Active Farms</h5>
          <h3 class="text-primary" id="activeFarms">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Total Sensors</h5>
          <h3 class="text-info" id="totalSensors">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Last Update</h5>
          <small id="lastUpdate" class="text-muted">Never</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Real-time Data Grid -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Live Sensor Data</h5>
          <small class="text-muted"
            >Updates every
            <span id="currentRefreshRate">10</span> seconds</small
          >
        </div>
        <div class="card-body">
          <div id="sensorGrid" class="row">
            <!-- Sensor data will be loaded here -->
            <div class="col-12 text-center">
              <p class="text-muted">
                Click "Start Monitor" to begin real-time monitoring
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Real-time Alerts</h5>
        </div>
        <div class="card-body">
          <div id="alertsContainer">
            <p class="text-muted">No alerts at this time</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let isMonitoring = false;
  let monitorInterval = null;
  let currentRefreshRate = 10; // seconds
  let selectedFarm = '';
  let selectedSensor = '';

  function toggleMonitoring() {
      const button = document.getElementById('toggleMonitor');

      if (isMonitoring) {
          // Stop monitoring
          isMonitoring = false;
          clearInterval(monitorInterval);
          button.innerHTML = '<i class="fas fa-play"></i> Start Monitor';
          button.classList.remove('btn-danger');
          button.classList.add('btn-success');
          updateConnectionStatus('Disconnected', 'danger');
      } else {
          // Start monitoring
          isMonitoring = true;
          button.innerHTML = '<i class="fas fa-stop"></i> Stop Monitor';
          button.classList.remove('btn-success');
          button.classList.add('btn-danger');
          updateConnectionStatus('Connected', 'success');

          // Start periodic updates
          loadSensorData();
          monitorInterval = setInterval(loadSensorData, currentRefreshRate * 1000);
      }
  }

  function changeRefreshRate() {
      const select = document.getElementById('refreshRate');
      currentRefreshRate = parseInt(select.value);
      document.getElementById('currentRefreshRate').textContent = currentRefreshRate;

      // Restart monitoring with new rate if currently monitoring
      if (isMonitoring) {
          clearInterval(monitorInterval);
          monitorInterval = setInterval(loadSensorData, currentRefreshRate * 1000);
      }
  }

  function changeFarm() {
      selectedFarm = document.getElementById('farmSelect').value;
      if (isMonitoring) {
          loadSensorData();
      }
  }

  function changeSensor() {
      selectedSensor = document.getElementById('sensorSelect').value;
      if (isMonitoring) {
          loadSensorData();
      }
  }

  function manualRefresh() {
      loadSensorData();
  }

  function loadSensorData() {
      const grid = document.getElementById('sensorGrid');
      grid.innerHTML = '<div class="col-12 text-center"><p class="text-muted">Loading sensor data...</p></div>';

      // Get data for all farms or selected farm
      const farms = selectedFarm ? [selectedFarm] : {{ farms|safe }};

      Promise.all(farms.map(farm => loadFarmData(farm)))
          .then(farmDataArray => {
              displaySensorData(farmDataArray.filter(data => data !== null));
              updateLastUpdate();
          })
          .catch(error => {
              console.error('Error loading sensor data:', error);
              grid.innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading sensor data</div></div>';
          });
  }

  async function loadFarmData(farmId) {
      try {
          // In a real implementation, this would make an API call to get farm data
          // For now, we'll simulate with a timeout
          await new Promise(resolve => setTimeout(resolve, 100));

          return {
              farm_id: farmId,
              sensors: {
                  soil: {
                      temperature: Math.round(Math.random() * 30 + 15),
                      moisture: Math.round(Math.random() * 100),
                      ph: (Math.random() * 3 + 6).toFixed(1),
                      conductivity: Math.round(Math.random() * 1000 + 500)
                  },
                  weather: {
                      temperature: Math.round(Math.random() * 35 + 10),
                      humidity: Math.round(Math.random() * 100),
                      pressure: Math.round(Math.random() * 100 + 1000),
                      wind_speed: (Math.random() * 20).toFixed(1)
                  }
              }
          };
      } catch (error) {
          console.error(`Error loading data for farm ${farmId}:`, error);
          return null;
      }
  }

  function displaySensorData(farmDataArray) {
      const grid = document.getElementById('sensorGrid');
      let html = '';
      let totalSensors = 0;

      farmDataArray.forEach(farmData => {
          Object.entries(farmData.sensors).forEach(([sensorType, sensorData]) => {
              if (!selectedSensor || selectedSensor === sensorType) {
                  totalSensors++;
                  html += createSensorCard(farmData.farm_id, sensorType, sensorData);
              }
          });
      });

      if (html === '') {
          html = '<div class="col-12 text-center"><p class="text-muted">No sensor data available</p></div>';
      }

      grid.innerHTML = html;
      document.getElementById('activeFarms').textContent = farmDataArray.length;
      document.getElementById('totalSensors').textContent = totalSensors;
  }

  function createSensorCard(farmId, sensorType, sensorData) {
      let html = `
          <div class="col-md-6 col-lg-4 mb-3">
              <div class="card border-primary">
                  <div class="card-header bg-primary text-white">
                      <h6 class="mb-0">${farmId.toUpperCase()} - ${sensorType.toUpperCase()}</h6>
                      <small>Real-time data</small>
                  </div>
                  <div class="card-body">
      `;

      Object.entries(sensorData).forEach(([key, value]) => {
          const unit = getUnit(key);
          const statusClass = getStatusClass(key, value);
          html += `
              <div class="row mb-1">
                  <div class="col-6"><small><strong>${key.toUpperCase()}:</strong></small></div>
                  <div class="col-6">
                      <span class="badge ${statusClass}">${value}${unit}</span>
                  </div>
              </div>
          `;
      });

      html += `
                  </div>
                  <div class="card-footer text-muted">
                      <small>Updated: ${new Date().toLocaleTimeString()}</small>
                  </div>
              </div>
          </div>
      `;

      return html;
  }

  function getUnit(key) {
      const units = {
          temperature: '°C',
          humidity: '%',
          moisture: '%',
          ph: '',
          conductivity: ' µS/cm',
          pressure: ' hPa',
          wind_speed: ' m/s',
          rainfall: ' mm'
      };
      return units[key] || '';
  }

  function getStatusClass(key, value) {
      // Simple status logic - in a real app, this would be more sophisticated
      if (key === 'moisture' && value < 30) return 'bg-danger';
      if (key === 'temperature' && (value < 10 || value > 35)) return 'bg-warning';
      if (key === 'ph' && (value < 6 || value > 8)) return 'bg-warning';
      return 'bg-success';
  }

  function updateConnectionStatus(status, type) {
      const statusEl = document.getElementById('connectionStatus');
      statusEl.textContent = status;
      statusEl.className = `badge bg-${type}`;
  }

  function updateLastUpdate() {
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
  }

  // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
      // Get farm parameter from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const farmParam = urlParams.get('farm');
      if (farmParam) {
          document.getElementById('farmSelect').value = farmParam;
          selectedFarm = farmParam;
      }
  });
</script>
{% endblock %}
