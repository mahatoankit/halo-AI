{% extends 'base.html' %} {% load static %} {% block title %}Crop Prediction -
Halo AI{% endblock %} {% block content %}
<div class="bg-gradient-to-br from-primary-50 to-secondary-50 py-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">Crop Prediction</h1>
      <p class="text-xl text-gray-600 max-w-3xl mx-auto">
        Get AI-powered crop recommendations based on your soil conditions,
        climate data, and farming requirements.
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Prediction Form -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <h2 class="text-2xl font-semibold text-gray-900 mb-6">
            Enter Farm Details
          </h2>

          <form id="crop-prediction-form" class="space-y-6" method="POST">
            {% csrf_token %}

            <!-- Soil Parameters -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <h3
                  class="text-lg font-medium text-gray-900 mb-4 flex items-center"
                >
                  <svg
                    class="w-5 h-5 mr-2 text-primary-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945"
                    />
                  </svg>
                  Soil Parameters
                </h3>
              </div>

              <div>
                <label
                  for="nitrogen"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Nitrogen (N) - mg/kg</label
                >
                <input
                  type="number"
                  id="nitrogen"
                  name="nitrogen"
                  step="0.00001"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                  placeholder="e.g., 80.12345"
                />
              </div>

              <div>
                <label
                  for="phosphorus"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Phosphorus (P) - mg/kg</label
                >
                <input
                  type="number"
                  id="phosphorus"
                  name="phosphorus"
                  step="0.00001"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                  placeholder="e.g., 42.12345"
                />
              </div>

              <div>
                <label
                  for="potassium"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Potassium (K) - mg/kg</label
                >
                <input
                  type="number"
                  id="potassium"
                  name="potassium"
                  step="0.00001"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                  placeholder="e.g., 38.12345"
                />
              </div>

              <div>
                <label
                  for="ph"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >pH Level</label
                >
                <input
                  type="number"
                  id="ph"
                  name="ph"
                  step="0.00001"
                  min="0"
                  max="14"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                  placeholder="e.g., 6.82345"
                />
              </div>
            </div>

            <!-- Climate Parameters -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <h3
                  class="text-lg font-medium text-gray-900 mb-4 flex items-center"
                >
                  <svg
                    class="w-5 h-5 mr-2 text-secondary-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"
                    />
                  </svg>
                  Climate Conditions
                </h3>
              </div>

              <div>
                <label
                  for="temperature"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Temperature (¬∞C)</label
                >
                <input
                  type="number"
                  id="temperature"
                  name="temperature"
                  step="0.00001"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                  placeholder="e.g., 25.54321"
                />
              </div>

              <div>
                <label
                  for="humidity"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Humidity (%)</label
                >
                <input
                  type="number"
                  id="humidity"
                  name="humidity"
                  step="0.00001"
                  min="0"
                  max="100"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                  placeholder="e.g., 65.23456"
                />
              </div>

              <div>
                <label
                  for="rainfall"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Annual Rainfall (mm)</label
                >
                <input
                  type="number"
                  id="rainfall"
                  name="rainfall"
                  step="0.00001"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                  placeholder="e.g., 1200.56789"
                />
              </div>

              <div>
                <label
                  for="location"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Location</label
                >
                <input
                  type="text"
                  id="location"
                  name="location"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                  placeholder="e.g., Bhairawa, Butwal, Nepal"
                />
              </div>
            </div>

            <!-- Farm Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <h3
                  class="text-lg font-medium text-gray-900 mb-4 flex items-center"
                >
                  <svg
                    class="w-5 h-5 mr-2 text-primary-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                    />
                  </svg>
                  Farm Information
                </h3>
              </div>

              <div>
                <label
                  for="area"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Farm Area (acres)</label
                >
                <input
                  type="number"
                  id="area"
                  name="area"
                  step="0.00001"
                  min="0.1"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                  placeholder="e.g., 2.54321"
                />
              </div>

              <div>
                <label
                  for="season"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Growing Season</label
                >
                <select
                  id="season"
                  name="season"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                >
                  <option value="">Select Season</option>
                  <option value="kharif">Kharif (Monsoon)</option>
                  <option value="rabi">Rabi (Winter)</option>
                  <option value="zaid">Zaid (Summer)</option>
                </select>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="pt-6">
              <button
                type="submit"
                class="w-full bg-primary-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-primary-700 focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors inline-flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                  />
                </svg>
                Get Crop Recommendations
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Information Panel -->
      <div class="space-y-6">
        <!-- Quick Tips -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h3
            class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
          >
            <svg
              class="w-5 h-5 mr-2 text-secondary-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            Quick Tips
          </h3>
          <ul class="space-y-3 text-sm text-gray-600">
            <li class="flex items-start">
              <svg
                class="w-4 h-4 mt-0.5 mr-2 text-primary-600 flex-shrink-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                />
              </svg>
              Test your soil regularly for accurate NPK values
            </li>
            <li class="flex items-start">
              <svg
                class="w-4 h-4 mt-0.5 mr-2 text-primary-600 flex-shrink-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                />
              </svg>
              Consider local climate patterns and seasonal variations
            </li>
            <li class="flex items-start">
              <svg
                class="w-4 h-4 mt-0.5 mr-2 text-primary-600 flex-shrink-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                />
              </svg>
              Market demand affects profitability
            </li>
            <li class="flex items-start">
              <svg
                class="w-4 h-4 mt-0.5 mr-2 text-primary-600 flex-shrink-0"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                />
              </svg>
              Water availability is crucial for crop success
            </li>
          </ul>
        </div>

        <!-- Real-Time Data Values -->
        <div class="bg-secondary-50 rounded-2xl shadow-lg p-6">
          <h3
            class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
          >
            <svg
              class="w-5 h-5 mr-2 text-secondary-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            Real-Time Data Sources
          </h3>
          <div class="space-y-2 text-sm" id="real-time-data-display">
            <div class="border-b border-gray-200 pb-2 mb-2">
              <div class="font-medium text-gray-700 mb-1">
                üå°Ô∏è IoT Sensors (Firebase)
              </div>
              <div class="text-gray-600 text-xs" id="firebase-data">
                <span class="inline-block animate-pulse text-orange-500"
                  >‚ãØ Loading real-time sensors data</span
                >
              </div>
            </div>

            <div class="border-b border-gray-200 pb-2 mb-2">
              <div class="font-medium text-gray-700 mb-1">
                üå§Ô∏è Weather API (Open-Meteo)
              </div>
              <div class="text-gray-600 text-xs" id="weather-data">
                <span class="inline-block animate-pulse text-orange-500"
                  >‚ãØ Loading weather data</span
                >
              </div>
            </div>

            <div class="border-b border-gray-200 pb-2 mb-2">
              <div class="font-medium text-gray-700 mb-1">
                üå± Regional Averages (Bhairahawa)
              </div>
              <div class="text-gray-600 text-xs" id="regional-data">
                <span class="inline-block animate-pulse text-orange-500"
                  >‚ãØ Loading regional data</span
                >
              </div>
            </div>

            <div class="text-xs text-gray-500 mt-3">
              <span class="text-green-600 font-semibold" id="data-timestamp"
                >Last updated: Loading...</span
              ><br />
              <span id="connection-status" class="text-blue-600"
                >üîÑ Connecting...</span
              ><br />
              üí° Click "Use Real-Time Data" to automatically fetch and fill
              current values<br />
              ‚ö° Click "Force Refresh" to manually update the display
            </div>
          </div>
          <button
            type="button"
            onclick="fillSampleData()"
            class="mt-4 w-full bg-secondary-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-secondary-700 transition-colors"
          >
            Use Sample Data
          </button>
          <button
            type="button"
            onclick="fillRealTimeData()"
            id="real-time-data-btn"
            class="mt-2 w-full bg-primary-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-primary-700 transition-colors"
          >
            üîÑ Use Real-Time IoT & Weather Data
          </button>
          <button
            type="button"
            onclick="forceRefreshData()"
            id="force-refresh-btn"
            class="mt-2 w-full bg-orange-500 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-orange-600 transition-colors"
          >
            ‚ö° Force Refresh Display
          </button>
        </div>

        <!-- Help -->
        <div class="bg-primary-50 rounded-2xl shadow-lg p-6">
          <h3
            class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
          >
            <svg
              class="w-5 h-5 mr-2 text-primary-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            Need Help?
          </h3>
          <p class="text-sm text-gray-600 mb-4">
            Don't know your soil parameters? Contact our agricultural experts
            for soil testing services.
          </p>
          <a
            href="#"
            class="text-primary-600 text-sm font-medium hover:text-primary-700 inline-flex items-center"
          >
            Contact Expert
            <svg
              class="ml-1 w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Results Modal -->
<div
  id="results-modal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50"
>
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Crop Recommendations</h2>
        <button
          onclick="closeModal()"
          class="text-gray-400 hover:text-gray-600"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
      <div id="results-content">
        <!-- Results will be loaded here -->
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  function fillSampleData() {
    document.getElementById("nitrogen").value = "80";
    document.getElementById("phosphorus").value = "42";
    document.getElementById("potassium").value = "38";
    document.getElementById("ph").value = "6.8";
    document.getElementById("temperature").value = "25.5";
    document.getElementById("humidity").value = "65";
    document.getElementById("rainfall").value = "1200";
    document.getElementById("location").value = "Bhairahawa, Nepal";
    document.getElementById("area").value = "2.5";
    document.getElementById("season").value = "kharif";
  }

  function fillRealTimeData() {
    const btn = document.getElementById("real-time-data-btn");
    const originalText = btn.innerHTML;
    btn.innerHTML = "üîÑ Loading Real-Time Data...";
    btn.disabled = true;

    // Show loading state in display panels
    document.getElementById("firebase-data").innerHTML =
      '<span class="inline-block animate-pulse text-orange-500">‚ãØ Fetching from Firebase...</span>';
    document.getElementById("weather-data").innerHTML =
      '<span class="inline-block animate-pulse text-orange-500">‚ãØ Fetching weather data...</span>';
    document.getElementById("regional-data").innerHTML =
      '<span class="inline-block animate-pulse text-orange-500">‚ãØ Fetching regional data...</span>';

    // Add cache-busting parameter to ensure fresh data
    const cacheBuster = new Date().getTime();
    const url = `/crop-prediction/api/real-time-data/?region=Bhairahawa-Butwal&_=${cacheBuster}`;

    console.log("üîÑ Fetching real-time data from:", url);

    // Fetch real-time data from our API which connects to Firebase
    fetch(url, {
      method: "GET",
      headers: {
        "Cache-Control": "no-cache, no-store, must-revalidate",
        Pragma: "no-cache",
        Expires: "0",
      },
    })
      .then((response) => {
        console.log("üîç Real-time data response status:", response.status);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then((data) => {
        console.log("üìä Real-time data received:", data);
        if (data.status === "success" && data.data) {
          const realData = data.data;
          console.log("‚úÖ Processing real-time data:", realData);

          // Validate data exists with safe fallbacks
          const ph =
            realData.ph !== undefined && !isNaN(realData.ph)
              ? parseFloat(realData.ph)
              : 6.5;
          const temperature =
            realData.temperature !== undefined && !isNaN(realData.temperature)
              ? parseFloat(realData.temperature)
              : 29.6;
          const rainfall =
            realData.rainfall !== undefined && !isNaN(realData.rainfall)
              ? parseFloat(realData.rainfall)
              : 22.5;
          const humidity =
            realData.humidity !== undefined && !isNaN(realData.humidity)
              ? parseFloat(realData.humidity)
              : 60;

          console.log("üî¢ Parsed values:", {
            ph,
            temperature,
            rainfall,
            humidity,
          });

          // Update display sections with real-time data
          document.getElementById("firebase-data").innerHTML = `
            pH: <span class="font-semibold text-green-700">${ph.toFixed(
              1
            )}</span>, 
            Temperature: <span class="font-semibold text-green-700">${temperature.toFixed(
              1
            )}¬∞C</span>
            <small class="block text-xs text-gray-500 mt-1">Sensor: ${
              realData.sensor_id || "unknown"
            }</small>
          `;

          document.getElementById("weather-data").innerHTML = `
            Rainfall: <span class="font-semibold text-green-700">${rainfall.toFixed(
              1
            )}mm</span>, 
            Humidity: <span class="font-semibold text-green-700">${humidity.toFixed(
              0
            )}%</span>
            <small class="block text-xs text-gray-500 mt-1">Source: ${
              realData.data_sources?.weather || "API"
            }</small>
          `;

          document.getElementById("regional-data").innerHTML = `
            N: <span class="font-semibold text-green-700">${
              realData.nitrogen || 30
            }</span>, 
            P: <span class="font-semibold text-green-700">${
              realData.phosphorus || 22.5
            }</span>, 
            K: <span class="font-semibold text-green-700">${
              realData.potassium || 60
            }</span> mg/kg
            <small class="block text-xs text-gray-500 mt-1">Source: ${
              realData.data_sources?.npk || "Regional avg"
            }</small>
          `;

          // Update timestamp with more info
          const timestamp = realData.timestamp
            ? new Date(realData.timestamp).toLocaleString()
            : new Date().toLocaleString();
          document.getElementById(
            "data-timestamp"
          ).innerHTML = `Last updated: <span class="font-semibold">${timestamp}</span><br><small>Region: ${
            realData.region || "Bhairahawa-Butwal"
          }</small>`;

          // Fill form with real-time data
          document.getElementById("nitrogen").value = realData.nitrogen || 30;
          document.getElementById("phosphorus").value =
            realData.phosphorus || 22.5;
          document.getElementById("potassium").value = realData.potassium || 60;
          document.getElementById("ph").value = ph;
          document.getElementById("temperature").value = temperature;
          document.getElementById("humidity").value = humidity;
          document.getElementById("rainfall").value = rainfall;
          document.getElementById("location").value = "Bhairahawa, Nepal";
          document.getElementById("area").value = "2.5";
          document.getElementById("season").value = "kharif";

          // Show success message with more details
          showNotification(
            `‚úÖ Real-time data loaded! pH: ${ph.toFixed(
              1
            )}, Temp: ${temperature.toFixed(1)}¬∞C (Sensor: ${
              realData.sensor_id || "N/A"
            })`,
            "success"
          );

          // Add real-time data indicator
          if (realData.data_sources) {
            addDataSourceIndicator(realData.data_sources);
          }
        } else {
          console.error("‚ùå API returned error or missing data:", data);
          setDefaultDataDisplay();
          showNotification(
            "‚ö†Ô∏è Failed to load real-time data: " +
              (data.message || "Unknown error"),
            "error"
          );
        }
      })
      .catch((error) => {
        console.error("‚ùå Error fetching real-time data:", error);
        setDefaultDataDisplay();
        showNotification(
          `‚ùå Error loading real-time data: ${error.message}. Using defaults.`,
          "error"
        );
        fillSampleData(); // Fallback to sample data
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
  }

  // Helper function to set default data display
  function setDefaultDataDisplay() {
    document.getElementById("firebase-data").innerHTML =
      'pH: 6.5, Temperature: 29.6¬∞C <span class="text-red-600">(Default)</span>';
    document.getElementById("weather-data").innerHTML =
      'Rainfall: 22.5mm, Humidity: 60% <span class="text-red-600">(Default)</span>';
    document.getElementById("regional-data").innerHTML =
      'N: 30, P: 22.5, K: 60 mg/kg <span class="text-red-600">(Default)</span>';
    document.getElementById("data-timestamp").innerHTML =
      'Last updated: <span class="text-red-600">Failed to connect</span>';
  }

  function addDataSourceIndicator(dataSources) {
    // Remove existing indicators
    const existingIndicator = document.querySelector(".data-source-indicator");
    if (existingIndicator) {
      existingIndicator.remove();
    }

    // Create new indicator
    const indicator = document.createElement("div");
    indicator.className =
      "data-source-indicator mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-sm";
    indicator.innerHTML = `
      <div class="flex items-center mb-2">
        <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span class="font-medium text-green-800">Real-Time Data Loaded</span>
      </div>
      <div class="text-green-700">
        <div>ÔøΩ Firebase Realtime DB: <span class="bg-orange-100 text-orange-800 px-1 py-0.5 rounded text-xs">${dataSources.iot_sensors}</span></div>
        <div>üå§Ô∏è Weather: <span class="bg-blue-100 text-blue-800 px-1 py-0.5 rounded text-xs">${dataSources.weather}</span></div>
        <div>üå± NPK Data: <span class="bg-green-100 text-green-800 px-1 py-0.5 rounded text-xs">${dataSources.npk}</span></div>
      </div>
      <div class="mt-2 text-xs text-gray-700">
        <span class="font-medium">Data applied to all form fields</span> - Ready for prediction!
      </div>
    `;

    // Insert after the "Use Real-Time Data" button
    const realTimeButton = document.getElementById("real-time-data-btn");
    realTimeButton.parentNode.insertBefore(
      indicator,
      realTimeButton.nextSibling
    );
  }

  function showNotification(message, type) {
    // Remove existing notifications
    const existingNotif = document.querySelector(".notification");
    if (existingNotif) {
      existingNotif.remove();
    }

    const notification = document.createElement("div");
    notification.className = `notification fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
      type === "success" ? "bg-green-500" : "bg-red-500"
    } text-white`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 5000);
  }

  function closeModal() {
    document.getElementById("results-modal").classList.add("hidden");
  }

  // Form submission handler - Updated to use real ML prediction API
  document
    .getElementById("crop-prediction-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      // Show loading state
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = `
            <svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            ü§ñ AI Analysis in Progress...
        `;
      submitBtn.disabled = true;

      // Collect form data
      const formData = new FormData(this);
      const requestData = {};
      formData.forEach((value, key) => {
        requestData[key] = value;
      });

      // Make API call to real ML prediction service
      fetch("/crop-prediction/api/predict/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
            .value,
        },
        body: JSON.stringify(requestData),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            showResults(data.data);
          } else {
            throw new Error(data.message || "Prediction failed");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showNotification("‚ùå Prediction failed: " + error.message, "error");

          // Show fallback results
          const fallbackResults = {
            recommended_crops: [
              {
                name: "Rice",
                confidence: 75,
                reason: "Fallback recommendation based on regional suitability",
                type: "primary",
              },
            ],
          };
          showResults(fallbackResults);
        })
        .finally(() => {
          // Restore button
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
    });

  function showResults(results) {
    const resultsContent = document.getElementById("results-content");
    let html = `
            <div class="space-y-4">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-green-800 mb-2">ü§ñ AI Analysis Complete</h3>
                    <p class="text-green-700">Our machine learning models have analyzed your farm conditions. Here are the recommendations:</p>
                </div>
        `;

    results.recommended_crops.forEach((crop, index) => {
      const bgColor =
        crop.type === "primary"
          ? "bg-primary-50 border-primary-200"
          : "bg-gray-50 border-gray-200";
      const textColor =
        crop.type === "primary" ? "text-primary-800" : "text-gray-800";
      const badge =
        crop.type === "primary"
          ? '<span class="bg-primary-100 text-primary-800 text-xs font-medium px-2 py-1 rounded-full">üéØ AI Recommended</span>'
          : '<span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-1 rounded-full">Alternative</span>';

      html += `
                <div class="${bgColor} border rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-lg font-semibold ${textColor}">${crop.name}</h4>
                        ${badge}
                    </div>
                    <div class="flex items-center mb-2">
                        <span class="text-sm text-gray-600">AI Confidence: </span>
                        <div class="ml-2 flex-1 bg-gray-200 rounded-full h-2">
                            <div class="bg-primary-500 h-2 rounded-full" style="width: ${crop.confidence}%"></div>
                        </div>
                        <span class="ml-2 text-sm font-medium">${crop.confidence}%</span>
                    </div>
                    <p class="text-sm text-gray-600">${crop.reason}</p>
                </div>
            `;
    });

    // Add model details if available
    if (results.model_details) {
      html += `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-blue-800 mb-2">üî¨ AI Model Details</h4>
                    <div class="text-xs text-blue-700 space-y-1">
                        <div>Models Used: ${
                          results.model_details.supporting_models
                            ? results.model_details.supporting_models.join(", ")
                            : "XGBoost, Random Forest, SVM"
                        }</div>
                        <div>Data Sources: IoT Sensors, Weather API, Regional Data</div>
                        <div>Analysis Method: Ensemble Machine Learning</div>
                    </div>
                </div>
            `;
    }

    html += `
                <div class="flex space-x-4 pt-4">
                    <button onclick="downloadReport()" class="flex-1 bg-primary-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-primary-700 transition-colors">
                        üìä Download AI Report
                    </button>
                    <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        `;

    resultsContent.innerHTML = html;
    document.getElementById("results-modal").classList.remove("hidden");
  }

  function downloadReport() {
    // Enhanced report download functionality
    showNotification("üìä Generating AI-powered crop report...", "success");

    // In a real implementation, this would generate a PDF report
    // For now, we'll show a notification
    setTimeout(() => {
      showNotification(
        "üìÑ Report generation coming soon! Contact support for detailed reports.",
        "success"
      );
    }, 2000);
  } // Auto-load real-time data on page load
  document.addEventListener("DOMContentLoaded", function () {
    // Fetch real-time data without filling the form fields
    fetchRealtimeDataForDisplay();

    // Set up auto-refresh every 30 seconds
    setInterval(fetchRealtimeDataForDisplay, 30000);

    // Uncomment the line below to auto-load real-time data when page loads
    // fillRealTimeData();
  });

  // Force refresh function for manual data refresh
  function forceRefreshData() {
    const btn = document.getElementById("force-refresh-btn");
    const originalText = btn.innerHTML;
    btn.innerHTML = "‚ö° Refreshing...";
    btn.disabled = true;

    // Clear cache and force fresh data
    fetchRealtimeDataForDisplay();

    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
      showNotification("üîÑ Display data refreshed!", "success");
    }, 2000);
  }

  // This function only updates the display panels without filling form fields
  function fetchRealtimeDataForDisplay() {
    // Update connection status
    const statusElement = document.getElementById("connection-status");
    if (statusElement) {
      statusElement.innerHTML = " Fetching live data...";
      statusElement.className = "text-blue-600";
    }

    // Show loading state in display panels
    document.getElementById("firebase-data").innerHTML =
      '<span class="inline-block animate-pulse text-orange-500">‚ãØ Connecting to Firebase...</span>';
    document.getElementById("weather-data").innerHTML =
      '<span class="inline-block animate-pulse text-orange-500">‚ãØ Fetching weather data...</span>';
    document.getElementById("regional-data").innerHTML =
      '<span class="inline-block animate-pulse text-orange-500">‚ãØ Fetching regional data...</span>';

    // Add cache-busting parameter to ensure fresh data
    const cacheBuster = new Date().getTime();
    const url = `/crop-prediction/api/real-time-data/?region=Bhairahawa-Butwal&_=${cacheBuster}`;

    console.log(" Auto-fetching display data from:", url);

    fetch(url, {
      method: "GET",
      headers: {
        "Cache-Control": "no-cache, no-store, must-revalidate",
        Pragma: "no-cache",
        Expires: "0",
      },
    })
      .then((response) => {
        console.log("üîç Display data response status:", response.status);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then((data) => {
        console.log(" Display data received:", data);
        if (data.status === "success" && data.data) {
          const realData = data.data;
          console.log(" Processing display data:", realData);

          // Validate data exists with fallbacks (for display function)
          const ph =
            realData.ph !== undefined && !isNaN(realData.ph)
              ? parseFloat(realData.ph)
              : 6.5;
          const temperature =
            realData.temperature !== undefined && !isNaN(realData.temperature)
              ? parseFloat(realData.temperature)
              : 29.6;
          const rainfall =
            realData.rainfall !== undefined && !isNaN(realData.rainfall)
              ? parseFloat(realData.rainfall)
              : 22.5;
          const humidity =
            realData.humidity !== undefined && !isNaN(realData.humidity)
              ? parseFloat(realData.humidity)
              : 60;

          console.log(" Display values: ", {
            ph,
            temperature,
            rainfall,
            humidity,
          });

          // Update display sections with real-time data
          document.getElementById("firebase-data").innerHTML = `
            pH: <span class="font-semibold text-green-700">${ph.toFixed(
              1
            )}</span>,
            Temperature: <span class="font-semibold text-green-700">${temperature.toFixed(
              1
            )}¬∞C</span>
            <small class="block text-xs text-gray-500 mt-1">Live from: ${
              realData.sensor_id || "unknown"
            }</small>
          `;

          document.getElementById("weather-data").innerHTML = `
            Rainfall: <span class="font-semibold text-green-700">${rainfall.toFixed(
              1
            )}mm</span>,
            Humidity: <span class="font-semibold text-green-700">${humidity.toFixed(
              0
            )}%</span>
            <small class="block text-xs text-gray-500 mt-1">Source: ${
              realData.data_sources?.weather || "API"
            }</small>
          `;

          document.getElementById("regional-data").innerHTML = `
            N: <span class="font-semibold text-green-700">${
              realData.nitrogen || 30
            }</span>,
            P: <span class="font-semibold text-green-700">${
              realData.phosphorus || 22.5
            }</span>,
            K: <span class="font-semibold text-green-700">${
              realData.potassium || 60
            }</span> mg/kg
            <small class="block text-xs text-gray-500 mt-1">Source: ${
              realData.data_sources?.npk || "Regional avg"
            }</small>
          `;

          // Update timestamp with sensor info
          const timestamp = realData.timestamp
            ? new Date(realData.timestamp).toLocaleString()
            : new Date().toLocaleString();
          document.getElementById(
            "data-timestamp"
          ).innerHTML = `Last updated: <span class="font-semibold text-green-600">${timestamp}</span><br><small>Sensor: ${
            realData.sensor_id || "N/A"
          }, Region: ${realData.region || "Bhairahawa-Butwal"}</small>`;

          // Update connection status
          if (statusElement) {
            statusElement.innerHTML = "‚úÖ Connected to Firebase";
            statusElement.className = "text-green-600";
          }
        } else {
          console.error(" Display API returned error or missing data:", data);
          setDefaultDataDisplayQuiet();

          // Update connection status
          if (statusElement) {
            statusElement.innerHTML = "‚ö†Ô∏è API Error";
            statusElement.className = "text-orange-600";
          }
        }
      })
      .catch((error) => {
        console.error(" Error fetching real-time data for display:", error);
        setDefaultDataDisplayQuiet();

        // Update connection status
        if (statusElement) {
          statusElement.innerHTML = " Connection Failed";
          statusElement.className = "text-red-600";
        }
      });
  }

  // Helper function to set default data display quietly (no error messages)
  function setDefaultDataDisplayQuiet() {
    document.getElementById("firebase-data").innerHTML =
      'pH: 6.5, Temperature: 29.6¬∞C <small class="block text-xs text-gray-500 mt-1">Default values</small>';
    document.getElementById("weather-data").innerHTML =
      'Rainfall: 22.5mm, Humidity: 60% <small class="block text-xs text-gray-500 mt-1">Default values</small>';
    document.getElementById("regional-data").innerHTML =
      'N: 30, P: 22.5, K: 60 mg/kg <small class="block text-xs text-gray-500 mt-1">Regional averages</small>';
    document.getElementById("data-timestamp").innerHTML =
      'Last updated: <span class="text-orange-600">No live connection</span><br><small>Using default values</small>';
  }
</script>
{% endblock %}
